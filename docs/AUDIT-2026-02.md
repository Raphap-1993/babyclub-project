# AUDIT 2026-02

## Metadatos
- Fecha de auditoria: 2026-02-13
- Alcance: arquitectura de BD (Supabase), queries criticas, arquitectura de `apps/backoffice` y `apps/landing`, resiliencia en Vercel/Supabase
- Metodo: auditoria por evidencia en repo + validacion de build/test local
- Limitacion: no se consulto `EXPLAIN ANALYZE` en produccion ni dashboards de Supabase/Vercel (inferencias marcadas como `Inferencia`).

## Resumen ejecutivo
- Estado general: Amarillo
- Causa principal del incidente de timeout: sobrecarga y drift de queries en dashboard admin.
- Causa secundaria de lentitud percibida en login/dashboard: consultas de sesion/perfil no criticas ejecutadas en ruta caliente.
- Riesgo actual para disponibilidad: Medio-Alto sin observabilidad SQL/latencia por query en produccion.

## Diagnostico del incidente (timeout dashboard)
### Sintoma reportado
- Logs del 2026-02-13 con `AbortError: This operation was aborted` para multiples operaciones en `admin/dashboard`.

### Hallazgo tecnico
- El dashboard ejecutaba muchas consultas en paralelo con timeout fijo de 6s y sin reintento: `apps/backoffice/app/admin/page.tsx:63`, `apps/backoffice/app/admin/page.tsx:198`.
- Habia drift de esquema/contrato en consultas del dashboard (columnas/estados no alineados al resto del codigo):
- `event_date` en vez de `starts_at`.
- `payments.status = succeeded` cuando el modulo Culqi usa `paid` (`supabase/migrations/2026-02-07-add-culqi-payments.sql:6`).
- Filtros de tickets por `payment_status` aunque ese campo no es parte del flujo actual de generacion de tickets (`apps/landing/app/api/tickets/route.ts:225`).
- `Inferencia`: la combinacion de alto paralelismo + timeout estricto + queries desalineadas explica abortos en cascada con timestamps casi identicos.

## Semaforo por checklist de arquitectura
| Area | Estado | Evidencia | Comentario |
|---|---|---|---|
| 1) Dominio y limites de modulos | Amarillo | `docs/ARCHITECTURE_V2.md:5`, `docs/STRANGLER_PLAN.md:42` | El target V2 esta definido, pero V1 sigue acoplado por app/ruta y query layer duplicado. |
| 2) API y contratos | Amarillo | `apps/backoffice/app/admin/page.tsx:222`, `apps/landing/app/api/events/route.ts:19` | Hay contratos funcionales, pero existen derivaciones no versionadas y drift de campos en dashboard. |
| 3) Datos y migraciones | Amarillo | `supabase/migrations/2026-01-31-add-soft-delete.sql:1`, `supabase/migrations/2026-02-10-backfill-table-reservation-codes-and-query-indexes.sql:45` | Estrategia aditiva correcta; faltaban indices orientados a consultas reales de dashboard/login. |
| 4) Seguridad | Amarillo | `packages/shared/auth/requireStaff.ts:28`, `apps/backoffice/app/admin/layout.tsx:84` | Roles/auth existen; no se observo breach, pero falta estandarizar controles y trazabilidad por request. |
| 5) Calidad y pruebas | Amarillo | `pnpm test` (2026-02-13), `pnpm --filter backoffice build` (2026-02-13) | Build de backoffice OK; suite global tiene 1 test fallando no relacionado (`apps/landing/app/api/reservations/route.test.ts:62`). |
| 6) Operacion y observabilidad | Amarillo | `apps/backoffice/app/admin/page.tsx:111`, `apps/landing/app/api/_utils/supabaseResilience.ts:76` | Se loguean errores, pero sin `correlation_id` transversal y sin metricas SQL por consulta. |
| 7) CI/CD y gobernanza | Rojo | `package.json:13`, `pnpm check-types` falla por task inexistente (2026-02-13) | Gate tecnico definido en AGENTS no se cumple completamente en scripts/pipeline actuales. |

## Hallazgos de arquitectura BD y queries
### H1. Queries calientes sin indices de cobertura completa
- Impacto: counts/rangos sobre `tickets` y busqueda de eventos/profiles pueden degradar con volumen.
- Evidencia: filtros frecuentes en `apps/backoffice/app/admin/page.tsx:225`, `apps/backoffice/app/admin/page.tsx:252`, `apps/backoffice/app/admin/page.tsx:293`, `apps/backoffice/app/auth/login/page.tsx:27`, `apps/backoffice/app/admin/layout.tsx:89`.
- Accion aplicada: nueva migracion `supabase/migrations/2026-02-13-dashboard-timeout-performance-indexes.sql:1`.

### H2. Drift de modelo entre dashboard y schema operativo
- Impacto: errores logicos/tiempos de respuesta inestables.
- Evidencia: queries previas usaban campos no alineados; se corrigio en `apps/backoffice/app/admin/page.tsx:240` y `apps/backoffice/app/admin/page.tsx:272`.

### H3. Endpoints resumen con potencial full-scan en memoria
- Impacto: riesgo de timeout al crecer tickets por evento.
- Evidencia: `packages/api-logic/qr-summary.ts:62` y `packages/api-logic/promoter-summary.ts:87` cargan tickets por lote y agregan en app.
- `Inferencia`: bajo volumen actual puede funcionar; en picos de eventos sera cuello de botella.

### H4. Repeticion de consultas de perfil/roles en layout admin
- Impacto: latencia acumulada en navegacion y carga inicial.
- Evidencia: efecto dependia de `pathname`; corregido para fetch unico + redirect separado en `apps/backoffice/app/admin/layout.tsx:68` y `apps/backoffice/app/admin/layout.tsx:119`.

### H5. Login bloqueado por consultas no criticas
- Impacto: tiempo extra antes de mostrar formulario.
- Evidencia: corregido en `apps/backoffice/app/auth/login/page.tsx:67` y `apps/backoffice/app/auth/login/page.tsx:87` para no bloquear por `brand_settings`.

## Cambios implementados en esta auditoria (2026-02-13)
1. `apps/backoffice/app/admin/page.tsx`
- timeout configurable (9s default), retry en errores transitorios, uso de `count: planned`, queries alineadas a schema actual, disponibilidad de mesas via `table_availability`.
2. `apps/backoffice/app/auth/login/page.tsx`
- redireccion de sesion mas rapida, lookup de rol con timeout controlado, carga de logo en segundo plano.
3. `apps/backoffice/app/admin/layout.tsx`
- perfil/roles consultados una sola vez por sesion de layout; redirect de rol puerta separado por cambio de ruta.
4. `supabase/migrations/2026-02-13-dashboard-timeout-performance-indexes.sql`
- indices aditivos para `tickets`, `events`, `payments`, `staff`, `table_availability`.

## Top 5 riesgos actuales (owner + fecha compromiso)
| Riesgo | Severidad | Owner sugerido | Fecha compromiso |
|---|---|---|---|
| Resumenes de dashboard/QR con agregacion en app (`full-read`) | Alto | Tech Lead Backend | 2026-02-20 |
| Falta de metricas SQL (p95 por query + explain en prod) | Alto | DevOps + DBA | 2026-02-18 |
| Contrato de datos no versionado para metricas admin | Alto | Arquitecto Software | 2026-02-19 |
| Gate `check-types` inexistente en scripts/pipeline | Medio | DevOps | 2026-02-17 |
| Inconsistencia de estrategia de resiliencia entre apps | Medio | Plataforma | 2026-02-21 |

## Validacion ejecutada
- `pnpm --filter backoffice build`: OK (2026-02-13).
- `pnpm lint`: OK (2026-02-13).
- `pnpm test`: 1 fallo no relacionado a estos cambios en `apps/landing/app/api/reservations/route.test.ts:62`.
- `pnpm check-types`: falla por task inexistente en turbo (`Missing tasks in project`).

## Siguientes pasos recomendados
1. Ejecutar la migracion nueva en Supabase y validar `pg_stat_statements` + p95 de queries de dashboard por 24 horas.
2. Crear endpoint/RPC unico de metricas (`/v2/dashboard/metrics`) para reemplazar agregaciones dispersas.
3. Refactorizar `packages/api-logic/qr-summary.ts` y `packages/api-logic/promoter-summary.ts` hacia agregacion SQL (GROUP BY) con limites por evento.
4. Alinear pipeline con gates reales: `test`, `lint`, `types`, `build` y reporte de tiempos.
