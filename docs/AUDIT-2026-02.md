# AUDIT 2026-02

## Alcance de esta revision
- Tipo: auditoria tecnica inicial (rapida)
- Fecha: 2026-02-07
- Fuente: evidencia en repo (codigo, docs, CI)
- No incluye: pruebas de carga, pentest, costos cloud, entrevistas de negocio

## Resumen ejecutivo
- Estado general: Amarillo
- Fortalezas:
  - estrategia arquitectonica V1 -> V2 ya definida en docs
  - base de migraciones SQL activa y con enfoque aditivo
  - cobertura de tests en rutas core seleccionadas
- Riesgos prioritarios:
  - CI incompleto para gate de calidad (sin lint/types/build)
  - idempotencia no estandarizada en flujos core V1
  - observabilidad sin correlation_id end-to-end

## Semaforo por area
| Area | Estado | Evidencia | Riesgo |
|---|---|---|---|
| Dominio y modularizacion | Amarillo | `docs/ARCHITECTURE_V2.md`, `docs/STRANGLER_PLAN.md` definen objetivo, pero aun no existen `apps/api-v2`, `packages/domain`, `packages/db` | Acoplamiento alto mientras V1 crece |
| API y contratos | Amarillo | Contratos V1 listados en `docs/STRANGLER_PLAN.md`; versionado V2 definido pero aun no implementado | Riesgo de regresion y cambios no versionados |
| Idempotencia | Rojo | En codigo actual no hay manejo explicito de `idempotency-key` en tickets (`apps/landing/app/api/tickets/route.ts`) | Duplicados por reintentos/red inestable |
| Datos y migraciones | Verde | Migraciones activas en `supabase/migrations/`; soft delete en `supabase/migrations/2026-01-31-add-soft-delete.sql` | Bajo si se mantiene disciplina |
| Seguridad | Amarillo | Rate limiting y soft delete documentados en `docs/SECURITY.md`; limitador in-memory | Escala limitada en multi-instancia |
| Calidad y QA | Amarillo | Hay tests unitarios/API en `*.test.ts`; CI actual solo corre `pnpm test` | Defectos de lint/types/build pueden pasar |
| Observabilidad | Amarillo | Existen `process_logs` y `scan_logs`; logger actual no adjunta `correlation_id` (`apps/backoffice/app/api/logs/logger.ts`) | Trazabilidad parcial en incidentes |
| CI/CD y release | Rojo | Workflow `.github/workflows/ci.yml` no ejecuta lint/types/build | Riesgo de deploy con fallas evitables |

## Hallazgos prioritarios (Top 5)
1. CI sin gates completos
   - Evidencia: `.github/workflows/ci.yml`
   - Impacto: cambios con errores de lint/types/build pueden llegar a deploy
   - Accion recomendada: agregar `pnpm lint`, `pnpm check-types`, `pnpm build`

2. Idempotencia incompleta en creacion de tickets/reservas
   - Evidencia: `apps/landing/app/api/tickets/route.ts` no usa clave de idempotencia
   - Impacto: duplicados por reintentos de cliente o timeout
   - Accion recomendada: implementar `Idempotency-Key` + tabla de dedupe

3. Observabilidad sin correlacion transversal
   - Evidencia: `apps/backoffice/app/api/logs/logger.ts` guarda logs sin `correlation_id`
   - Impacto: investigacion lenta de incidentes
   - Accion recomendada: propagar `correlation_id` en request y persistirlo

4. Documentacion raiz desactualizada
   - Evidencia: `README.md` aun refleja starter de Turborepo
   - Impacto: onboarding lento y errores operativos
   - Accion recomendada: reemplazar README con setup real, comandos y arquitectura actual

5. Riesgo de escalado en rate limiting
   - Evidencia: `docs/SECURITY.md` indica limiter in-memory por proceso
   - Impacto: limites inconsistentes entre instancias
   - Accion recomendada: migrar a storage compartido (Redis/Upstash) para produccion

## Plan de correccion propuesto (30 dias)
### Semana 1
- Endurecer CI: test + lint + types + build
- Actualizar README con guia operativa real

### Semana 2
- Implementar correlation_id en middleware/handlers y logs
- Definir formato estandar de respuesta de error

### Semana 3
- Implementar idempotencia en `POST /api/tickets`
- Agregar tests de reintento y no duplicacion

### Semana 4
- Disenar modulo base de `apps/api-v2`
- Extraer primer caso de uso (Scan o Tickets) con feature flag

## Evidencia usada
- `docs/ARCHITECTURE_V2.md`
- `docs/STRANGLER_PLAN.md`
- `docs/SECURITY.md`
- `.github/workflows/ci.yml`
- `apps/landing/app/api/tickets/route.ts`
- `apps/backoffice/app/api/logs/logger.ts`
- `supabase/migrations/2026-01-31-add-soft-delete.sql`

## Pendientes para auditoria completa
- KPIs operativos reales (latencia, error rate, MTTR)
- Revision de costos/limites de Supabase y Vercel
- Requisitos de negocio por temporada/picos de trafico
- Politica de backups, restore y pruebas de DR
